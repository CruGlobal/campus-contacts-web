sudo: false
cache:
  bundler: true
  directories:
    - node_modules
    - cache
    - ../../../.nvm/versions
language: ruby
rvm: 2.3.4
branches:
  only:
    - master
    - staging
services:
  - redis-server

before_install:
  - bundle config gems.contribsys.com $SIDEKIQ_CREDS
  - nvm install node
  - npm install

before_script:
  - bundle exec rake db:create db:structure:load RAILS_ENV=test

script:
  - npm test
  - bundle exec rake test
  - bundle exec rake spec
  - bundle exec rubocop -R

env:
  - REDIS_PORT_6379_TCP_ADDR=localhost REDIS_PORT_6379_TCP_PORT=6379 APP_DOMAIN=localhost.com
