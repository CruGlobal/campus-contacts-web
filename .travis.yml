sudo: false
cache:
  bundler: true
  directories:
    - node_modules
    - cache
language: ruby
rvm: 2.3.0
branches:
  only:
    - master
    - staging
    - new-dashboard
services:
  - redis-server

before_install:
- nvm install node
- npm install
- npm install karma-chrome-launcher --save-dev

before_script:
  - cp config/s3.travis.yml config/s3.yml
  - cp config/database.travis.yml config/database.yml
  - cp config/config.travis.yml config/config.yml
  - bundle exec rake db:create RAILS_ENV=test
  - bundle exec rake db:structure:load RAILS_ENV=test

script:
  - ./node_modules/.bin/eslint app/assets/javascripts/angular
  - ./node_modules/.bin/karma start --single-run --browsers Chrome
  - bundle exec rake test
  - bundle exec rake spec
  - bundle exec rubocop -R

env:
  - REDIS_PORT_6379_TCP_ADDR=localhost REDIS_PORT_6379_TCP_PORT=6379 APP_DOMAIN=localhost.com
