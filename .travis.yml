language: ruby
rvm: 1.9.3
branches:
  only:
    - master
services:
  - redis-server

notifications:
  recipients:
    - josh.starcher@cojourners.com
    # - kennethjohnbalgos@gmail.com

before_script:
  - mysql -e 'create database missionhub_test;'
  - "mysql -e 'USE missionhub_test; CREATE TABLE roles (id int(11) NOT NULL AUTO_INCREMENT, organization_id int(11) DEFAULT NULL, name varchar(255) DEFAULT NULL, i18n varchar(255) DEFAULT NULL, created_at datetime DEFAULT NULL, updated_at datetime DEFAULT NULL, PRIMARY KEY (id)) ENGINE=InnoDB AUTO_INCREMENT=438 DEFAULT CHARSET=utf8;'"
  - "mysql -e 'USE missionhub_test; CREATE TABLE simplesecuritymanager_user ( userID int(10) NOT NULL AUTO_INCREMENT, globallyUniqueID varchar(80) DEFAULT NULL, username varchar(200) NOT NULL, password varchar(80) DEFAULT NULL, passwordQuestion varchar(200) DEFAULT NULL, passwordAnswer varchar(200) DEFAULT NULL, lastFailure datetime DEFAULT NULL, lastFailureCnt int(10) DEFAULT NULL, lastLogin datetime DEFAULT NULL, createdOn datetime DEFAULT NULL, emailVerified tinyint(1) NOT NULL DEFAULT '0', remember_token varchar(255) DEFAULT NULL, remember_token_expires_at datetime DEFAULT NULL, developer tinyint(1) DEFAULT NULL, facebook_hash varchar(255) DEFAULT NULL, facebook_username varchar(255) DEFAULT NULL, fb_user_id bigint(20) DEFAULT NULL, password_plain varchar(255) DEFAULT NULL, password_reset_key varchar(255) DEFAULT NULL, locale varchar(255) DEFAULT NULL, checked_guid tinyint(4) NOT NULL DEFAULT '0', settings text, PRIMARY KEY (userID), UNIQUE KEY CK_simplesecuritymanager_user_username (username), UNIQUE KEY globallyUniqueID (globallyUniqueID), KEY index_simplesecuritymanager_user_on_fb_user_id (fb_user_id)) ENGINE=InnoDB AUTO_INCREMENT=2318043 DEFAULT CHARSET=utf8;'"
  - "mysql -e 'USE missionhub_test; CREATE TABLE authentications ( id int(11) NOT NULL AUTO_INCREMENT, user_id int(11) DEFAULT NULL, provider varchar(255) DEFAULT NULL, uid varchar(255) DEFAULT NULL, created_at datetime DEFAULT NULL, updated_at datetime DEFAULT NULL, PRIMARY KEY (id), UNIQUE KEY uid_provider (uid,provider)
) ENGINE=InnoDB AUTO_INCREMENT=18999 DEFAULT CHARSET=utf8;'"
  - cp config/database.travis.yml config/database.yml
  - cp config/config.travis.yml config/config.yml
  - bundle exec rake db:migrate RAILS_ENV=test

script: "bundle exec rake test"