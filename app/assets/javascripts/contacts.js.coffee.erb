$ ->
  $('.friends_count').live 'click', ->
    false
  $('.to_list a.delete').live 'click', ->
    li = $(this).closest('li')
    li.remove()
    false
    
  $('#send_reminder_link').live 'click', -> 
    $('.to_list').html('')
    ids = []
    $('#leaders .leader').each ->
      if Number($('.count', this).text()) > 0
        id = $(this).attr('data-id')
        ids.push(id)
        $('.to_list').append('<li data-id="'+id + '">'+$('.name a', this).html() + ' <a href="" class="delete">x</a></li>')
    $('#reminder_email').dialog
      resizable: false,
      height:444,
      width:600,
      modal: true,
      buttons: 
        Cancel: ->
          $(this).dialog('destroy')
    false
    
  $('#reminder_email form').live 'submit', ->
    ids = []
    $('.to_list li').each ->
      id = $(this).attr('data-id')
      ids.push(id)
    $('#to').val(ids.join(','))
    $('#reminder_email').dialog('destroy')
    $.rails.handleRemote($(this))
    false
    
  if $.params.answers
    $.each $.params.answers, (k, v) ->
      if $.isPlainObject(v)
        # Checkboxes
        $.each v, (k1, v1) ->
          if v1 != ""
            $("[name='answers[" + k + "][" + k1 + "]']").prop('checked', true)
      else
        field = $("[name='answers[" + k + "]']")
        if field.attr('type') == 'radio'
          field.prop('checked', true)
        else
          field.val(v)

  $('#filter_link').click -> 
    $('#filter_box').toggle()
    false
    
  $('#add_contact_div .save').live 'click', ->
    form = $(this).closest('form')
    if $('#person_firstName', form).val() == '' or ($('#person_email_address_email', form).val() == '' &&$('#person_phone_number_number', form).val() == '')
      alert('At a minimum you need to provide a first name and either an email address or a phone number.')
      return false
    if $(this).hasClass('save_and_more')
      $('#add_another').val('true')
    $.rails.handleRemote(form)
    form.html("<img src=\"<%= asset_path('spinner.gif') %>\" />")
    false
    
  $('#contacts_controller a.add_contact').live 'click', ->
    $('#new_person')[0].reset()
    $('#add_contact_div').dialog
      resizable: false,
      height:444,
      width:600,
      modal: true,
      buttons: 
        Cancel: ->
          $(this).dialog('destroy')
    false
          
  $('#survey_answers_link').live 'click', ->
    $('#survey_answers').dialog
      resizable: false,
      height:444,
      width:600,
      modal: true,
      buttons: 
        Cancel: ->
          $(this).dialog('destroy')
    false
  $('#assign_search .assign_button').live 'click', ->
    leader = $('.leftmenu .leader[data-id=' + $('#assign_to').val() + ']')
    $.fn.assignTo(leader)
    $('#assign_search').dialog('destroy')
    
  $('#assign_search .leader a').live 'click', (e)->
    $('#assign_to').val($(this).closest('li').attr('data-id'))
    e.preventDefault()
    leader = $('.leftmenu .leader[data-id=' + $('#assign_to').val() + ']')
    if leader[0]
      $.fn.assignTo(leader)
    else
      $.rails.handleRemote($('#new_contact_assignment'))
      unless $('#assign_to').val() == $('#my_id').val()
        console.log($('.id_checkbox:checked'))
        $('.id_checkbox:checked').each ->
          $(this).closest('tr').remove();
    $('#assign_search').dialog('destroy')
  false
    
  $('#assign_search .org a').live 'click', (e)->
    e.preventDefault()
    form = $('#new_contact_assignment')
    from_id = $(this).closest('div').attr('data-org-id')
    to_id = $(this).attr('data-id')
    old_action = form.attr('action')
    form.attr('action', '/organizational_roles/move_to?from_id='+from_id+'&to_id='+to_id)
    $.rails.handleRemote(form)
    $('.id_checkbox:checked').each ->
      $(this).closest('tr').remove();
    form.attr('action', old_action)
    $('#assign_search').dialog('destroy')
  false
    
  $('#assign_search .leader_search_name').keyup ->
    name = $('#assign_search .leader_search_name').val()
    $('#assign_search ul li').each ->
      regex = new RegExp('.*' + name + '.*', 'i')
      if regex.test($('.name', $(this)).text())
        $(this).show()
      else
        $(this).hide()
        
  $('#assign_to_me, #assign_to_unassigned').live 'click', ->
    $('#assign_search .leader_search').hide()
    $('#assign_search .org_search').hide()
    $('#assign_search .assign_button').show()
    
  $('#assign_to_leader').live 'click', ->
    $('#assign_search .leader_search').show()
    $('#assign_search .org_search').hide()
    $('#assign_search .assign_button').hide()
    
  $('#assign_to_org').live 'click', ->
    $('#assign_search .leader_search').hide()
    $('#assign_search .org_search').show()
    $('#assign_search .assign_button').hide()
    
  $('.assign_to_radio').live 'click', -> 
    $('#assign_to').val($(this).val())
    
  $("#contacts_controller a.assign").live 'click', ->
    if $('.id_checkbox:checked').length > 0
      $('#assign_to_me').click()
      el = $('#assign_search')
      # $('#add_leader_form').hide()
      # $('#leader_search_form').show()
      # $('#leader_search_name').val('')
      # $("#leader_search_results").hide()
      # form = $('#leader_search_form')
      el.dialog
        resizable: false,
        height:444,
        width:400,
        modal: true,
        buttons: 
          Cancel: ->
            $(this).dialog('destroy')
    else
      alert("<%= I18n.t('contacts.index.none_checked') %>")
    false

  $('#contacts_controller #bulk_unassign').live 'click', ->
    if $('.id_checkbox:checked').length > 0
      $.rails.handleRemote($('#new_contact_assignment'))
      $('.id_checkbox:checked').closest('tr').fadeOut()
    $('#check_all').prop('checked', false)
    false
    
  $('#contacts_controller .controls a.delete').live 'click', (e)->
    $(this).closest('tr').fadeOut()
    if $('#leaders')[0]?
      $('.id_checkbox', $(this).closest('tr')).prop('checked', true)
      $.fn.assignTo($('.leader.dnc'), true)
    false
    
  $('#contacts_controller .controls a.unassign').live 'click', (e)->
    # $(this).closest('tr').fadeOut()
    if $('#leaders')[0]?
      $('.id_checkbox', $(this).closest('tr')).prop('checked', true)
      $.fn.assignTo($('.leader.unassigned'), true)
      $('.id_checkbox', $(this).closest('tr')).prop('checked', false)
    false
  $('a.delete_leader').live 'click', ->
    li = $(this).parent()
    li.fadeOut 'slow', ->
      li.remove()

  $("a.add-leader").live 'click', ->
    $('#add_leader_form').hide()
    $('#leader_search_form').show()
    $('#leader_search_name').val('')
    $("#leader_search_results").hide()
    $('#new_leader_form').hide();
    el = $('#leader_search')
    el.dialog
      resizable: false,
      height:450,
      width:400,
      modal: true,
      buttons: 
        Cancel: ->
          $(this).dialog('destroy')
    false

  $('#leader_search_name').autocomplete
    source: (request, response)->
      form = $('#leader_search_form')
      $('#spinner_leader_search').show()
      $.ajax
        url: form.attr('action'), 
        data: form.serialize(), 
        type: 'POST',
        success: (data)->
          $('#leader_search_results').html(data)
          $("#leader_search_results").show()
        complete: ->
          $('#spinner_leader_search').hide()
        error: (xhr, status, error)->
          alert(error)
      response([]);
  $('.search_show_all_link').live 'click', ->
    $('#spinner_leader_search').show()
    $('#show_all').val('true')
    form = $('#leader_search_form')
    $.ajax
      url: form.attr('action')
      data: form.serialize(),
      type: 'POST',
      success: (data)->
        $('#leader_search_results').html(data)
        $("#leader_search_results").show()
      complete: ->
        $('#spinner_leader_search').hide()
    false;
    
  $('#comment_submit').live 'click', ->
    $(this).hide()
    $('#spinner_comment').show()
    
  $('#add_rejoicable').live 'click', ->
    $('#rejoicable_fields').slideToggle()
    false
    
  $('.contact_row td:not(.checkbox_cell)').live 'click', ->
    unless $('a', this)[0]?
      tr = $(this).parent()
      document.location = '/contacts/' + tr.attr('data-id')
    
  $('.person_row td:not(.checkbox_cell)').live 'click', ->
    unless $('a', this)[0]?
      tr = $(this).parent()
      document.location = '/people/' + tr.attr('data-id')
  
  $('#assign_to').change ->
    if $('.id_checkbox:checked').length > 0
      name = $('option:selected', this).text()
      person_id = $(this).val()
      $.fn.assignTo($('li[data-id=' + person_id + ']'))
      $('#check_all').prop('checked', false)
    else
      alert("<%= I18n.t('contacts.index.none_checked') %>")
  $('#contacts_controller .index a.hide').live 'click', ->
    $('.' + $(this).attr('data-class')).fadeOut()
  
  $('#hidden_questions_link').live 'click', ->
    $('#hidden_questions_div').slideToggle()
    false
  $('.handle').draggable 
    revert: true
    start: (event, ui) ->
      # If this row isn't checked, store the previously checked rows and check this row '
      unless $(this).next('input').prop('checked') 
        $(this).data 'checked',  $('.id_checkbox:checked').map ->
          return $(this).val()
        $('.id_checkbox:checked').prop('checked', false) 
        $(this).next('input').prop('checked', true) 
    stop: (event, ui) ->
      if $(this).data('checked')?
        $(this).next('input').prop('checked', false)
        $.each $(this).data('checked'), (i, id) ->
          $('.id_checkbox[value=' + id + ']').prop('checked', true)
    helper: (event) ->
      length = if $(this).next('input').prop('checked') then $('.id_checkbox:checked').length else 1
      helper_text = "<%= I18n.t('contacts.index.assign_people', count: 0) %>".replace('0', length)
      if length == 1
        helper_text = "<%= I18n.t('contacts.index.assign_people', count: 1) %>"
      $('<div class="drag-contact">' + helper_text + '</div>').appendTo($('body'));

  $.fn.activateLeaderDroppable()
  
$.fn.activateLeaderDroppable = () ->
  $('.leftmenu .leader').droppable 
    activeClass: 'ui-state-highlight'
    drop: (event, ui) ->
      leader = $(this)
      leader.effect('highlight', {}, 'slow')
      $('#assign_to').val(leader.attr('data-id'))
      $.fn.assignTo(leader)
      
$.fn.assignTo = (leader, skip_remote) ->
  leader_name = $('.name a', leader).text()
  $('.id_checkbox:checked').each ->
    row = $('tr[data-id=' + $(this).val() + ']')
    assigned_to = $('.assigned_to', row)
    if leader_name == 'Unassigned'
      $('.unassign_link', row).hide()
    else
      $('.unassign_link', row).show()
      
    unless assigned_to.html() == leader_name
      $('.count', leader).html(Number($('.count', leader).html()) + 1)
      if assigned_to.html() == ''
        $('#unassigned_count').html(Number($('#unassigned_count').html()) - 1)
      else
        $('.leader a').each ->
          if $(this).text() == assigned_to.html() || (leader.hasClass('unassigned') && assigned_to.html() == '')
            count = $(this).closest('.leader').find('.count')
            count.html(Number(count.html()) - 1)
      if leader.hasClass('unassigned') or leader.hasClass('dn')
        assigned_to.text('') 
      else
        assigned_to.text(leader_name) 
    # hide people assigned to someone other than the current
    if $.params.assigned_to != 'all' && $.params.assigned_to != leader_name
      row.hide();
  unless skip_remote
    $.rails.handleRemote($('#new_contact_assignment'))
  $('#assign_to').val('')