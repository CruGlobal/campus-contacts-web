constructArray = (string) ->
  string = string.toLowerCase()
  string = string.replace(/[^a-zA-Z0-9 ]+/g, "").replace("/ {2,}/", " ")
  string = string.split(" ")
  results = new Array()
  i = 0
  while i < string.length
    results = results.concat(string[i].split("_"))
    i++
  results

compare = (userString, mhubString, matchQuestions) ->
  match = undefined
  matchArray = undefined
  mhubArray = undefined
  userArray = undefined
  userArray = constructArray(userString)
  mhubArray = constructArray(mhubString)
  matchArray = _.intersection(userArray, mhubArray)
  match = matchArray.length / mhubArray.length
  if match >= 0.75
    true
  else
    i = 0
    while i < userArray.length
      secondMatch = false
      ii = 0
      while ii < mhubArray.length
        if mhubArray[ii].indexOf(userArray[i]) isnt -1 and matchQuestions.indexOf(mhubString) is -1
          secondMatch = true
          break
        ii++
      i++
    secondMatch

$(document).ready ->
    
  userQuestions = []
  mhubQuestions = []
  matchQuestions = []
  
  $("table tr td:first-child").each ->
    userQuestions.push $(this).text().replace(/:/gi, "").toLowerCase()

  $(".selectQuestions:first .surveyQuestions .surveyItem").each ->
    mhubQuestions.push $(this).text()

  i = 0

  while i < userQuestions.length
    matchFound = false
    ii = 0
    
    while ii < mhubQuestions.length
      if compare(userQuestions[i], mhubQuestions[ii], matchQuestions) is true
        matchFound = true
        break
      ii++
    if matchFound is true
      matchQuestions.push mhubQuestions[ii]
    else
      matchQuestions.push "Create new question"
    i++
  i = 0
  
  $(".selectTitle").each (i) ->
    $(this).text(matchQuestions[i])
    $(this).parents(".matchSelect").siblings(".matchEdit").css "display", "block"  if $(this).text() is "Create new question"
    
  $(".selectTitleBg").live "click", (e) ->
    e.preventDefault()
    $(this).siblings(".selectQuestions").toggle().scrollTop(0)

  $(".surveyItem, .noMatch").live "click", (e) ->
    e.preventDefault()
    selectedItem = $(this).text()
    $(this).parents(".matchSelect").find(".selectTitle").text selectedItem
    $(".selectQuestions").hide()

  $("html").click (e) ->
    $(".selectQuestions").hide()  unless $(e.target).is(".selectTitleBg, .selectTitle")

  $('.newQuestion').live 'click', (e) ->
    e.preventDefault()
    clickedElement = $(this).parents(".matchSelect").attr("id")
    $('#new_question_div').dialog
      resizable: false,
      height:444,
      width:600,
      modal: true,
      buttons: [
        text: 'Done',
        click: ->
          $("#" + clickedElement).siblings(".matchEdit").css("display", "block")
          $(this).dialog('destroy')
      ,
        text: 'Cancel',
        click: ->
          $(this).dialog('destroy')
      ]
    false

  $('.editMatch').live 'click', (e) ->
    e.preventDefault()
    $('#new_question_div').dialog
      resizable: false,
      height:444,
      width:600,
      modal: true,
      buttons: [
        text: 'Done',
        click: ->
          $(this).dialog('destroy')
      ,
        text: 'Cancel',
        click: ->
          $(this).dialog('destroy')
      ]
    false